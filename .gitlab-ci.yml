variables:
  DOCKER_VERSION: "19.03.8"

test:
  image: registry.gitlab.com/nikathone/image-utils/docker:$DOCKER_VERSION-compose
  stage: test
  # variables:
  #   DOCKER_DRIVER: overlay2
  #   DOCKER_TLS_CERTDIR: "/certs"
  services:
    - docker:$DOCKER_VERSION-dind
  before_script:
    - docker --version && docker-compose --version
  script:
    - mv .github/docker-compose.override.yml docker-compose.override.yml
    - mv .github/.dockerignore .dockerignore
    - ls -all scripts/drupal/
    - echo "$HOME"
    - chmod +x scripts/drupal/init.sh
    - make
    - >
      while ! docker container logs islandora_drupal_1 | grep "nginx entered RUNNING state"; do
        echo "Waiting for the site to be installed!"
        sleep 2m
      done
    - curl -s http://localhost:8000 | grep '<h1 class="title page-title">Welcome to islandora</h1>'
  after_script:
    - echo "$(uname -s)"
    - if [[ -f /etc/os-release ]]; then cat /etc/os-release; fi
  only:
    refs:
      - master
      - development
